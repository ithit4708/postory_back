<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jungsuk_2_1.postory.dao.ProfileDao">
    <select id="findUserByNickname" parameterType="String" resultType="UserDto">
        SELECT *
        FROM user
        WHERE nic = #{nic};
    </select>

    <select id="findProfileUserByNic" parameterType="String" resultType="ProfileUserDto">
        SELECT *
        FROM user
        WHERE nic = #{nic};
    </select>

    <select id="existsChannelByUserId" parameterType="String" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM channel WHERE CRT_ID = #{userId}) AS channel_exists;
    </select>

    <select id="findProfileChannelByNic" parameterType="Map" resultType="ProfileChannelDto">
        SELECT c.chnl_img_path, c.chnl_ttl, c.suber_cnt, c.chnl_intro, c.chnl_uri, c.CHNL_ID,
               CASE WHEN s.user_id IS NOT NULL THEN 1 ELSE 0 END AS isSubsed, c.SUBER_CNT
        FROM user u
                 INNER JOIN channel c ON u.user_id = c.crt_id
                 LEFT JOIN subscription s ON #{userId} = s.user_id AND c.CHNL_ID = s.CHNL_ID
        WHERE u.user_id = #{profileUserId}
        ORDER BY c.CHNL_OPEN_DTM;
    </select>

    <select id="findProfilePostsByUserId" parameterType="Map" resultType="ProfilePostsDto">
        SELECT c.chnl_id, se.ser_id, se.SER_TTL, p.POST_ID, p.POST_TTL, p.POST_SB_TTL, p.POST_REP_CNT,p.POST_INQR_CNT, p.POST_LIK_CNT,
               p.POST_PBLC_DTM, p.POST_THUMN_PATH, u.USER_IMG_PATH, u.NIC,
               CASE WHEN sc.user_id IS NULL THEN 0 ELSE 1 END AS isScraped
        FROM post p
                 INNER JOIN channel c ON p.CHNL_ID = c.CHNL_ID
                 LEFT JOIN scrap sc ON p.POST_ID = sc.POST_ID AND sc.USER_ID = #{loginUserId}
                 LEFT JOIN series se ON p.SER_ID = se.SER_ID
                 INNER JOIN user u ON c.CRT_ID = u.USER_ID
        WHERE c.CRT_ID = #{profileUserId}
        ORDER BY p.POST_PBLC_DTM DESC
        LIMIT #{offset}, 5;
    </select>

    <select id="findProfileSeriesByUserId" parameterType="Map" resultType="ProfileSeriseDto">
        SELECT s.ser_thumn_path, s.ser_ttl, s.ser_desc, s.ser_inqr_cnt, s.ser_lik_cnt, s.ser_rep_cnt, s.ser_post_cnt, s.SER_ID,
               u.NIC
        FROM series s
                 LEFT JOIN channel c on s.chnl_id = c.chnl_id
                 INNER JOIN user u ON c.CRT_ID = u.USER_ID
        where c.crt_id = #{profileUserId}
        ORDER BY s.ser_open_dtm
        LIMIT #{offset}, 5;
    </select>
</mapper>